---
title: "Eksploratorna analiza Spotify skupa podataka"
author: "36558993 Ivan Josip Kardum, 36557629 Damjan Crnković"
date: "`r Sys.Date()`"
output:
  pdf_document: default

---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(stringi)
library(tidyverse)
library(lubridate)
library(kernlab)
library(caret)
library(ranger)
library(MASS)
knitr::opts_chunk$set(echo = TRUE)
```
U ovom izvještaju provedena je eksploratorna analiza skupa podataka "Spotify songs dataset
(Kaggle)", koji sadrži oko 30 000 pjesama s opisanim svojstvima poput popularnosti, plesnosti, tempa i tonaliteta. Cilj analize je statističkom obradom i vizualizacijom podataka ispitati odnose između žanra, audio svojstava i popularnosti pjesama te istražiti kako su se te značajke mijenjale tijekom vremena. Također, izrađeni su modeli za predviđanje popularnosti pjesama na temelju njihovih svojstava i žanra.  


Pri učitavanju podataka iz CSV datoteke, nakon čega slijedi osnovna analiza, proučavamo strukturu skupa podataka, prvih nekoliko zapisa te sažetak varijabli kako bismo stekli uvid u njihove karakteristike.

```{r, results='hide'}
data <- read_csv("spotify_songs.csv")
```

```{r}
glimpse(data)
# head(data, 10)
# summary(data)
```
Skup podataka sadrži 23 varijable koje opisuju pjesme, uključujući audio značajke, žanr, popularnost te informacije o albumima. Ove varijable omogućuju analizu odnosa između svojstava pjesama i njihove popularnosti.

# Priprema podataka

Uočavamo da stupac s datumima treba pretvoriti u ispravan tip te da imamo nekoliko kategoričkih varijabli koje treba faktorizirati kako bismo ih po potrebi mogli koristiti za grupiranje u vizualizacijama i analizi.

```{r}
data$track_album_release_date <- as.Date(data$track_album_release_date)

data$mode <- factor(
  data$mode,
  levels = c(0, 1),
  labels = c("Minor", "Major")
)

factcols <- c("playlist_genre", "playlist_subgenre", "playlist_name", "track_artist")
data[factcols] <- lapply(data[factcols], as.factor)

```

# 1) Kako se audio svojstva razlikuju po žanrovima?

Zanima nas koje audio značajke odlikuju žanrove i koliko se žanrovi razlikuju po tim svojstvima. Provjeravamo odnos energije, plesnosti, pozitivnosti i tempa sa žanrom.

```{r}
data %>%
  dplyr::select(playlist_genre, energy, danceability, valence, tempo) %>%
  pivot_longer(-playlist_genre, names_to = "svojstva", values_to = "vrijednosti") %>%
  ggplot(aes(x = playlist_genre, y = vrijednosti, fill = playlist_genre)) +
  geom_boxplot() +
  facet_wrap(~ svojstva, scales = "free_y") +
  labs(title = "Žanrovi po svojstvima pjesama",
       x = "",
       y = "") +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5)) +
  theme_bw()
```

Pregledom grafova vidimo da se žanrovi najviše razlikuju po plesnosti i energiji, gdje su razlike u medijanima vizualno očite, a varijabilnost približno ista (vidljivo po interkvantilnom rangu). Tempo pokazuje male razlike među žanrovima te se čini da nema značajan utjecaj pri klasificiranju pjesme u određeni žanr. Pozitivnost (valence) je također slična među većinom žanrova, uz iznimku EDM žanra koji odstupa s niskom razinom pozitivnosti i latin žanra koji ima blago veću razinu od ostalih. Analiza je provedena na razini playlisti, pri čemu se ista pjesma može pojaviti u više žanrova, što je prihvatljivo jer je cilj analize usporediti karakteristike po žanrovima a ne pojedinim pjesmama.

# 2) Utječe li mode (dur/mol) na popularnost pjesama?

Dur (Major) ljestvice u glazbi zvuče veselije i svijetlije od pripadajućih mol (Minor) ljestvica, pa analiziramo postoji li razlika u popularnosti pjesama s obzirom na glazbeni mod. Uklonit ćemo višestruka pojavljivanja određenih pjesama kako ne bi negativno utjecala na rezultate.

```{r}
data2 <- distinct(data, track_id, .keep_all = T)

data2 %>% ggplot(aes(x = mode, y = track_popularity, fill = mode)) +
  geom_boxplot() +
  labs(title = "Popularnost pjesama u ovisnosti o glazbenom modu",
       x = "Glazbeni mod",
       y = "Popularnost") +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5)) +
  theme_bw()
```

Pregledom grafičkog prikaza ne uočava se jasna razlika u popularnosti između pjesama pisanih u duru i molu. Medijani popularnosti vrlo su slični, a distribucije se u velikoj mjeri preklapaju, što upućuje na to da glazbeni mod sam po sebi nema izražen utjecaj na popularnost pjesama.


# 3) Je li energija pjesme povezana s tempom i glasnoćom?

Energija pjesme je svojstvo koje je teško objektivno definirati te se često definira pomoću drugih svojstava. Zanima nas postoji li veza između tempa i glasnoće i percipirane energičnosti pjesama. Opet ćemo pri analizi gledati jedinstvene pjesme (bez ponavljanja). U drugom grafu ograničavamo se na 99.9% podataka kako stršeće vrijednosti ne bi remetile izgled grafa.

```{r}
ggplot(data2, aes(x = tempo, y = energy)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", se = F) +
  theme_bw()

ggplot(data2, aes(x = loudness, y = energy)) +
  geom_point(alpha = 0.2) +
  coord_cartesian(
    xlim = quantile(data2$loudness, c(0.001, 0.999)),
    ylim = quantile(data2$energy, c(0.001, 0.999))
  ) +
  geom_smooth(method = "lm", se = F) +
  theme_bw()

model <- lm(energy ~ tempo + loudness, data = data2)
summary(model)
```

Linearni regresijski model potvrđuje uočene odnose s grafova. Glasnoća ima snažan i pozitivan utjecaj na energiju pjesme, dok je povezanost između tempa i energije statistički značajna, ali znatno slabijeg intenziteta. Vrijednost R^2 pokazuje da tempo i glasnoća zajedno objašnjavaju oko 47% varijabilnosti energije, što upućuje na to da energija pjesme ovisi i o drugim svojstvima koja ovdje nisu analizirana. Rezultati su u skladu s očekivanjima, budući da je glasnoća jedna od ključnih komponenti percepcije energičnosti glazbe, iako je utjecaj tempa možda bio manji od očekivanog.

# 4) Kako su se audio karakteristike pjesama mijenjale kroz vrijeme?

U ovom dijelu analize cilj je ispitati kako su se ključne audio karakteristike pjesama (danceability, energy i valence) mijenjale kroz godine.
Budući da nas zanima vremenski trend, prvo je potrebno pripremiti podatke i izdvojiti godinu iz datuma izdanja albuma.  

Iz podatkovnog skupa uklanjamo zapise bez poznatog datuma izdanja te iz varijable track_album_release_date izdvajamo godinu izdanja.

```{r}
data_modified <- data %>% 
  filter(!is.na(data$track_album_release_date)) %>% 
  mutate(relase_year = year(track_album_release_date))
```
Kao početni korak, prikazujemo promjenu danceability. Ovakav prikaz pokazuje veliku varijabilnost jer sadrži sve pojedinačne pjesme.

```{r}
ggplot(data_modified, aes(x = track_album_release_date, y = danceability)) + 
  geom_line(color = "red") + 
  labs(
    title = "Promjena Danceability kroz vrijeme (po pjesmama)",
    x = "Datum izdanja",
    y = "Danceability"
  ) +
  theme_bw()
```
Iako graf sadrži veliku količinu šuma, služi kao motivacija za agregaciju podataka na godišnjoj razini.  

Kako bismo dobili jasniju sliku dugoročnih trendova, agregiramo podatke po godinama i računamo srednje vrijednosti odabranih audio karakteristika:
```{r}
yearly <- data_modified %>% 
  group_by(relase_year) %>% 
  summarise(
    mean_d = mean(danceability),
    mean_e = mean(energy),
    mean_v = mean(valence)
  )
```

Prije prikaza, pogledajmo broj podataka po desetljeću:

```{r}
data_modified %>% 
  mutate(decade = floor(relase_year / 10) * 10) %>% 
  count(decade)
```
Primjećujemo vrlo mali broj podataka u pedesetim i šezdesetim godinama, što može uzrokovati nekonzistentnost i šum na grafičkom prikazu.


U nastavku istovremeno prikazujemo promjene prosječne plesnosti (danceability), energije (energy) i emocionalne pozitivnosti (valence) kroz godine, ograničavajući interval na 1970. godinu nadalje. Podaci su dodatno zaglađeni kako bi se smanjio utjecaj godišnjih oscilacija i jasno istaknuo dugoročni trend, pri čemu se i dalje zadržava pregled stvarnih promjena kroz vrijeme.
```{r}
ggplot(yearly %>% filter(relase_year >= 1970), aes(x = relase_year)) + 
  geom_line(aes(y = mean_d, color = "Danceability"), alpha = 0.4) + 
  geom_line(aes(y = mean_e, color = "Energy"), alpha = 0.4) + 
  geom_line(aes(y = mean_v, color = "Valence"), alpha = 0.4) + 
  geom_smooth(aes(y = mean_d, color = "Danceability"), se = FALSE) +
  geom_smooth(aes(y = mean_e, color = "Energy"), se = FALSE) +
  geom_smooth(aes(y = mean_v, color = "Valence"), se = FALSE) +
  labs(
    title = "Prosječne audio karakteristike pjesama kroz godine (1970 nadalje)",
    x = "Godina izdanja",
    y = "Prosječna vrijednost",
    color = "Karakteristika"
  ) +
  theme_bw()
```
Plesnost (danceability) je doživjela znatan porast u razdoblju od 1970. do 1995. godine, što je vjerojatno povezano s popularnošću plesnih i disko ritmova tog doba, dok nakon 1995. dolazi do stagnacije.

Energija (energy) postepeno raste kroz cijelo promatrano razdoblje, pokazujući kontinuirani trend intenzivnijih i dinamičnijih produkcija u pjesmama.

Emocionalna pozitivnost (valence) od 2000. nadalje strmoglavo opada, što sugerira da novije pjesme, iako ritmički i energetski snažnije, postaju emocionalno ozbiljnije ili manje vedre.


# 5) Koje varijable utječu na popularnost pjesme?
Cilj ovog dijela analize je istražiti koje karakteristike pjesme utječu na njezinu popularnost. Koristimo **track_popularity** kao ciljnu (zavisnu) varijablu, a sve relevantne numeričke i kategorijske varijable kao prediktore. Prvo primjenjujemo tradicionalnu linearnu regresiju, zatim kompleksnije neuronske metode kako bismo identificirali najbolji model za predikciju.

Prvi korak u izradi prediktivnog modela je podjela podataka na trening set i test set. Trening set koristimo za učenje modela, a test set za provjeru koliko dobro model radi na novim, nepoznatim podacima.
```{r}
set.seed(1234)
train_size <- 0.7 * nrow(data) %>% round
train_ind <- sample(1:nrow(data), train_size)

data_train <- data[train_ind,]
data_test <- data[-train_ind,]
 
```

Prije modeliranja uklanjamo varijable koje ne pomažu u predviđanju popularnosti, poput ID-eva, imena i datuma.

```{r}

data_train <- data_train %>% 
  dplyr::select(-track_id, -track_name, -playlist_name, -track_album_id, -track_album_name, -track_artist, -playlist_id, -playlist_subgenre, -track_album_release_date)
data_test <- data_test %>% 
  dplyr::select(-track_id, -track_name, -playlist_name, -track_album_id, -track_album_name, -track_artist, -playlist_id, -playlist_subgenre, -track_album_release_date)
```

Sada koristimo višestruku linearnu regresiju kako bismo procijenili utjecaj svake varijable na popularnost pjesme.

```{r}
lmMod <- lm(track_popularity ~ ., data = data_train)
summary(lmMod)
```
Linearni model pokazuje da nekoliko varijabli, poput žanra playlisti, danceability, loudness i instrumentalness, značajno utječe na popularnost pjesama. Neke varijable, poput key, mode i speechiness, nisu statistički značajne i ne doprinose predikciji popularnosti.

Definiramo funkcije za izračun RMSE i R² kako bismo ocijenili točnost modela:
```{r}
rmse <- function(pred, stv) {
  sqrt(mean((pred - stv)^2))
}

r_squared <- function(pred, true) {
  1 - sum((pred - true)^2) / sum((true - mean(true))^2)
}
```
Procjenjujemo točnost linearne regresije pomoću RMSE i R² na testnom skupu:
```{r}
data_test$predPopularityLM <- predict(lmMod, data_test)

rmse_lm <- rmse(data_test$predPopularityLM, data_test$track_popularity)
r2_lm <- r_squared(data_test$predPopularityLM, data_test$track_popularity)

cat("Linearna regresija RMSE:", rmse_lm, "\n")
cat("Linearna regresija R**2:", r2_lm, "\n")
```
Rezultati pokazuju da linearna regresija slabo predviđa popularnost pjesama, s velikom prosječnom pogreškom od oko 24 (skala 1-100). Niska vrijednost R² (0.09) znači da model objašnjava samo mali dio varijacije popularnosti.

Sada koristimo slučajnu šumu za predviđanje popularnosti pjesama, jer nakon linearne regresije želimo poboljšati točnost predikcija. Uz primjenu cross-validation procjenjujemo pouzdanost modela, a zatim predviđamo popularnost na testnom skupu i izračunavamo RMSE i R² za ocjenu točnosti.
```{r, results='hide'}
ctrl <- trainControl(
  method = "repeatedcv",
  number = 5,
  repeats = 2,
  verboseIter = TRUE
)

rfMod <- train(
  track_popularity ~ .,
  data = data_train,
  method = 'ranger',
  tuneLength = 5,
  trControl = ctrl,
  num.trees = 20  
)
```

```{r}

data_test$predPopularityRF <- predict(rfMod, data_test)

rmse_rf <- rmse(data_test$predPopularityRF, data_test$track_popularity)
r2_rf <- r_squared(data_test$predPopularityRF, data_test$track_popularity)

cat("Slučajna šuma RMSE:", rmse_rf, "\n")
cat("Slučajna šuma R²:", r2_rf, "\n")

```
Model slučajne šume smanjio je RMSE u odnosu na linearnu regresiju, što znači da model bolje predviđa popularnost pjesama u prosjeku. Vrijednost R² se više nego udvostručila, što pokazuje da slučajna šuma objašnjava znatno veću varijabilnost popularnosti. To potvrđuje da složeniji model bolje hvata nelinearne i međusobne odnose između varijabli nego model linearne regresije.  

Vizualizirajmo za kraj usporedbu stvarnih i predviđenih vrijednosti popularnosti pomoću modela slučajne šume.

```{r}
ggplot(data_test, aes(x = track_popularity, y = predPopularityRF)) +
  geom_point(alpha = 0.3, color = "blue") +
  geom_abline(intercept = 0, slope = 1, color = "red") +
  labs(
    title = "Predviđeno vs Stvarno: Random Forest",
    x = "Stvarna popularnost",
    y = "Predviđena popularnost"
  ) +
  theme_bw()

```
Predviđene vrijednosti popularnosti su prilično raspršene; za mnoge pjesme s popularnošću blizu nule model predviđa znatno više vrijednosti. Iako se neke točke grupiraju oko dijagonale, odstupanja su velika, što se slaže s visokim vrijednostima RMSE i umjerenim R².


# Zaključak

**1) Kako se audio svojstva razlikuju po žanrovima?**  
Najveće razlike među žanrovima vidljive su u plesnosti i energiji, dok tempo i valence ostaju relativno slični, uz manje odstupanje određenih žanrova poput EDM-a i latina.  

**2) Utječe li mode (dur/mol) na popularnost pjesama?**   
Popularnost pjesama ne ovisi značajno o modu, jer se medijani i distribucije dur i mol pjesama uvelike preklapaju.  

**3) Je li energija pjesme povezana s tempom i glasnoćom?**   
Glasnoća snažno utječe na energiju pjesme, tempo ima slabiji, ali statistički značajan utjecaj, a zajedno objašnjavaju čak 47% varijabilnosti energije, što pokazuje da ove dvije karakteristike imaju značajan utjecaj na percepciju energičnosti pjesme.   

**4) Kako su se audio karakteristike pjesama mijenjale kroz vrijeme?**   
Plesnost je značajno porasla do 1995. godine, energija postupno raste kroz cijelo razdoblje, dok emocionalna pozitivnost od 2000. nadalje znatno opada, pokazujući trend ritmički i energetski snažnijih, ali emocionalno ozbiljnijih pjesama.  

**5) Koje varijable utječu na popularnost pjesme? **  
Linearni model pokazuje da žanr playlisti, danceability, loudness i instrumentalness značajno utječu na popularnost pjesama, dok key, mode i speechiness nemaju značajan utjecaj. Model slučajne šume bolje hvata nelinearne i međusobne odnose među varijablama te objašnjava znatno veću varijabilnost popularnosti.





